<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Vue sécurisée (15s)</title>
<style>
  html, body { background:#111; margin:0; height:100%; width:100%; overflow:hidden; }
  body { min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  #s { padding:10px; font:16px system-ui; color:#999; text-align:center; }
  #cv { max-width:100%; background:#000; display:block; margin:auto; user-select:none; pointer-events:none; }
  #login {margin-bottom:20px;}
  input[type="password"] {
    padding:7px; font-size:1em; border-radius:5px; border:1px solid #444; background:#222; color:#fff; outline:none;
  }
  button {padding:7px 14px; font-size:1em; border-radius:5px; border:none; background:#2a5; color:#fff; cursor:pointer;}
  button:disabled {background:#444;cursor:not-allowed;}
  .hidden {display:none;}
  #overlay, #blocker {
    position:fixed; top:0; left:0; width:100vw; height:100vh;
    background:rgba(0,0,0,0.88); color:#fff; display:flex; align-items:center; justify-content:center;
    font-size:1.3em; z-index:1000; transition:opacity 0.2s; text-align:center;
    pointer-events: none;
  }
</style>
</head>
<body>
<div id="s"></div>
<div id="login">
  <label for="pw">Mot de passe OpenPGP&nbsp;:</label>
  <input type="password" id="pw" autocomplete="off" autofocus>
  <button id="btn" disabled>Déchiffrer le document</button>
</div>
<canvas id="cv"></canvas>
<div id="overlay">Veuillez entrer le mot de passe pour déchiffrer le document</div>
<div id="blocker" class="hidden"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/openpgp/5.11.2/openpgp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.worker.min.js";

// --- Chemin relatif vers ton fichier gpg ---
const GPG_URL = "secure/encrypted.pdf.gpg";
const S = m => document.getElementById('s').textContent = m;
const blocker = document.getElementById('blocker');
const overlay = document.getElementById('overlay');
const cv = document.getElementById('cv');

// Champ mot de passe et bouton
const pw = document.getElementById('pw');
const btn = document.getElementById('btn');

// Activation du bouton
pw.addEventListener('input',()=>btn.disabled = !pw.value);

// Protection (appliquée **après** déchiffrement)
function activateProtection() {
  // Bloquer souris
  ['mousedown','mouseup','click','dblclick','contextmenu','wheel','mousemove','mouseenter','mouseleave','mouseover','mouseout','drag','drop'].forEach(ev=>{
    document.body.addEventListener(ev,e=>{
      e.stopPropagation(); e.preventDefault();
      blocker.textContent = "Action souris interdite"; blocker.classList.remove('hidden');
      setTimeout(()=>blocker.classList.add('hidden'), 1800);
    }, true);
  });
  // Bloquer clavier
  document.addEventListener('keydown',e=>{
    e.preventDefault(); blocker.textContent = "Clavier désactivé"; blocker.classList.remove('hidden');
    setTimeout(()=>blocker.classList.add('hidden'), 1800);
  }, true);
  // Bloquer copier/coller/sélection/drag partout
  ['copy','cut','paste','selectstart','dragstart'].forEach(ev=>{
    document.addEventListener(ev,e=>{e.preventDefault();blocker.textContent="Action interdite";blocker.classList.remove('hidden');setTimeout(()=>blocker.classList.add('hidden'),1800);}, true);
  });
  // Bloquer accès au menu contextuel partout
  document.addEventListener('contextmenu',e=>{e.preventDefault();blocker.textContent="Menu contextuel interdit";blocker.classList.remove('hidden');setTimeout(()=>blocker.classList.add('hidden'),1800);}, true);
  // Floutage/déconnexion si focus perdu
  window.addEventListener('blur',()=>{
    S('Affichage suspendu. Recharger la page.');
    cv.width = 1; cv.height = 1;
    overlay.textContent = "Session fermée (perte de focus)";
    overlay.classList.remove('hidden');
    setTimeout(()=>{ window.close(); location.replace('about:blank'); }, 900);
  });
}

// Déchiffrement
btn.addEventListener('click', async ()=>{
  btn.disabled = true;
  S('Chargement du fichier chiffré...');
  try {
    const r = await fetch(GPG_URL, {cache:'no-store'});
    if (!r.ok) throw Error('HTTP '+r.status);
    S('Lecture du fichier...');
    const enc = new Uint8Array(await r.arrayBuffer());

    S('Déchiffrement...');
    const msg = await openpgp.readMessage({binaryMessage:enc});
    const {data} = await openpgp.decrypt({message:msg,passwords:[pw.value],format:'binary'});
    enc.fill(0);

    S('Affichage PDF...');
    const pdf = await pdfjsLib.getDocument({data:new Uint8Array(data),disableFontFace:true}).promise;
    const page = await pdf.getPage(1);
    const ctx = cv.getContext('2d',{alpha:false});
    const vp = page.getViewport({scale:1.5});
    cv.width = vp.width; cv.height = vp.height;
    await page.render({canvasContext:ctx,viewport:vp}).promise;

    S('Affichage temporaire. Fermeture automatique dans 15 s…');
    document.getElementById('login').classList.add('hidden');
    overlay.classList.add('hidden');

    // Activer la protection APRES déchiffrement
    activateProtection();

    setTimeout(()=>{
      try{ cv.width=1; cv.height=1; }catch(_){}
      window.close(); location.replace('about:blank');
    },15000);

    // Détection très basique d’extensions
    setTimeout(()=>{
      if(window.chrome && window.chrome.runtime && window.chrome.runtime.sendMessage) {
        blocker.textContent="Attention : Extension Chrome détectée !"; blocker.classList.remove('hidden'); setTimeout(()=>blocker.classList.add('hidden'),1800);
      }
      if(window.navigator.plugins && window.navigator.plugins.length > 0) {
        for(const p of navigator.plugins) {
          const n=(p.name||"").toLowerCase();
          if(n.includes("screenshot")||n.includes("capture")) {blocker.textContent="Extension de capture détectée !";blocker.classList.remove('hidden'); setTimeout(()=>blocker.classList.add('hidden'),1800);}
        }
      }
    },1000);

  }catch(e){
    S('Erreur : '+(e?.message||e));
    console.error('Erreur complète:', e);
    pw.value = ''; btn.disabled = true;
    overlay.textContent = "Échec du déchiffrement";
    overlay.classList.remove('hidden');
  }
});
</script>
</body>
</html>
